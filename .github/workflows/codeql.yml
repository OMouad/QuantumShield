name: CodeQL

on:
  push:
    branches: ["**"]
  pull_request:
  schedule:
    - cron: '0 4 * * 1'

permissions:
  contents: read
  security-events: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze (Java)
    runs-on: ubuntu-latest
    steps:
      - name: Harden Runner (audit)
        uses: step-security/harden-runner@v2
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: 'java'

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: maven
      
      - name: Install unzip (Linux runners)
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: Install Maven 3.9.9 (GitHub runner)
        run: |
          curl -fsSL -o /tmp/maven.tgz https://archive.apache.org/dist/maven/maven-3/3.9.9/binaries/apache-maven-3.9.9-bin.tar.gz
          sudo tar -xzf /tmp/maven.tgz -C /opt
          sudo ln -s /opt/apache-maven-3.9.9 /opt/maven
          echo "/opt/maven/bin" >> "$GITHUB_PATH"

      - name: Build
        run: mvn -B -ntp -DskipTests package

      - name: Perform CodeQL Analysis
        if: ${{ !env.ACT }}
        uses: github/codeql-action/analyze@v3
